# csrf

## 总结图

![](/image/脑图/CSRF跨站请求伪造.png)

## 1、用自己的语言描述csrf攻击原理

当用户登录某个网站时，产生会话，然后去点击带有csrf攻击程序的web，CSRF攻击利用网站对于用户网页浏览器的信任，挟持用户当前已登陆的Web应用程序，去执行并非用户本意的操作。

## 2、csrf攻击分类

**CSRF漏洞一般分为站外和站内两种类型。**

**CSRF站外类型**的漏洞本质上就是传统意义上的外部提交数据问题。通常程序员会考虑给一些留言或者评论的表单加上水印以防止SPAM问题（这里，SPAM可以简单的理解为垃圾留言、垃圾评论，或者是带有站外链接的恶意回复），但是有时为了提高用户的体验性，可能没有对一些操作做任何限制，所以攻击者可以事先预测并设置请求的参数，在站外的Web页面里编写脚本伪造文件请求，或者和自动提交的表单一起使用来实现GET、POST请求，当用户在会话状态下点击链接访问站外Web页面，客户端就被强迫发起请求。

 **CSRF站内类型**的漏洞在一定程度上是由于程序员滥用`$_REQUEST`类变量造成的。在一些敏感的操作中（如修改密码、添加用户等），本来要求用户从表单提交发起POST请求传递参数给程序，但是由于使用了$_REQUEST等变量，程序除支持接收POST请求传递的参数外也支持接收GET请求传递的参数，这样就会为攻击者使用CSRF攻击创造条件。一般攻击者只要把预测的请求参数放在站内一个贴子或者留言的图片链接里，受害者浏览了这样的页面就会被强迫发起这些请求。

## 3、csrf漏洞检测方法。

1、抓取一个正常请求的数据包，去掉Referer字段后再重新提交，如果该提交还有效，那么基本上可以确定存在CSRF漏洞

2、扫描器扫描，但误报较高，后台登录，修改密码等可能扫不出csrf漏洞

## 4、完成csrf脱库、添加帐号、更新密码实验

**Csrf脱库**：一般xiaz开源代码去观看路径一般不会改变；一级目录可以在url中看到

在搭建好的DZ注册普通，然后发帖，插入远程图片，URL为：

`http://192.168.0.106:8080/dzcrst/uc_server/admin.php?m=db&a=operate&t=export&appid=0&backupdir=xxxx%26backupfilename%3Daaaa`

此链接为数据库备份操作

然后管理员点进去便会执行可以写一些吸引管理员的文字

![](/image/csrf/1.jpg)

![2](/image/csrf/2.jpg)

此时，我们可以访问默认备份路径及我们重命名的文件夹和文件名：http://192.168.1.224:8082/dzcsrt/uc_server/data/backup/xxxx/aaaa-1.sql

![](/image/csrf/3.jpg)

**添加帐号：**

![](/image/csrf/4.jpg)

![5](/image/csrf/5.jpg)

**修改密码：**

当我们登录DVWA后，在CSRF中：

LOW级别时：直接修改密码即可。

medium级别时：Referer得为网站修改页面的路径。否则会修改失败

## 5、csrf防范方法

目前业界服务器端防御CSRF攻击主要有5种策略：

1验证HTTP Referer字段（可以突破）

根据HTTP协议，在HTTP头中有一个字段叫Referer，它记录了该HTTP请求的来源地址。在通常情况下，访问一个安全受限页面的请求必须来自于同一个网站。

2、在请求地址中添加token并验证

在请求中放入攻击者所不能伪造的信息，并且该信息不存在于Cookie之中。鉴于此，系统开发者可以在HTTP请求中以参数的形式加入一个随机产生的token，并在服务器端建立一个拦截器来验证这个token，如果请求中没有token或者token内容不正确，则认为可能是CSRF攻击而拒绝该请求。

3、在HTTP头中自定义属性并验证

自定义属性的方法也是使用token并进行验证，和前一种方法不同的是，这里并不是把token以参数的形式置于HTTP请求之中，而是把它放到HTTP头中自定义的属性里。通过XMLHttpRequest这个类，可以一次性给所有该类请求加上csrftoken这个HTTP头属性，并把token值放入其中。这样解决了前一种方法在请求中加入token的不便，同时，通过这个类请求的地址不会被记录到浏览器的地址栏，也不用担心token会通过Referer泄露到其他网站。

4、在服务端区严格区分好POST与GET的数据请求

如在asp中不要使用Request来直接获取数据。同时建议不要用GET请求来执行持久性操作，如：[http://www.yeeyan.com/space/deleteEvent/16824](https://links.jianshu.com/go?to=http%3A%2F%2Fwww.yeeyan.com%2Fspace%2FdeleteEvent%2F16824)。

5、使用验证码或者密码确认方式进行

6、用户端防御

用户养成良好的上网习惯，则能够很大程度上减少CSRF攻击的危害

7、安全设备防御

用户可以借助第三方的专业安